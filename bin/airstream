#!/usr/bin/env ruby

require 'airstream'

options = {
  reciever: '192.168.1.8',
  quiet: false,
  verbose: false,
  use_local_http: false,
  http_path: '/var/www/html/airstream/',
  http_url: 'http://192.168.1.2/airstream/'
}

CONFIG_FILE = File.join(ENV['HOME'], '.airstreamrc')

if File.exists? CONFIG_FILE
  options_config = YAML.load_file(CONFIG_FILE)
  options.merge!(options_config)
else
  File.open(CONFIG_FILE,'w') { |file| YAML::dump(options,file) }
  STDERR.puts "Initialized configuration file in #{CONFIG_FILE}"
end

option_parser = OptionParser.new do |opts|
  executable_name = File.basename($PROGRAM_NAME)
  opts.banner = "offer a video file to an airplay device

Usage: #{executable_name} [options] [url|path/]filename

Basic options: (configure default in ~/.airstreamrc)
"

  opts.on("-o RECIEVER",
   "the airplay-device ip-address or domain") do |reciever|
    options[:reciever] = reciever
  end

  opts.on("-q","--quiet",
   "prevent most of the output") do |quiet|
    options[:quiet] = quiet
  end

  opts.on("--verbose",
   "additional output") do |verbose|
    options[:verbose] = verbose
  end

  opts.on("--enable-use-httpd",
   "use httpd to offer local files") do |use_httpd|
    options[:use_local_httpd] = true
  end

  opts.on("-u HTTP_URL",
   "the local webserver url") do |http_url|
    options[:http_url] = http_url
  end

  opts.on("-p HTTP_PATH",
   "the local webserver directory path") do |path|
    options[:http_path] = path
  end

  # opts.on("--cleanup",
  #  "remove the local webserver files and exit") do |path|
  #   FileUtils.rm(Dir.glob(options[:http_path] + '/*'))
  #   exit 0
  # end

  opts.on("-v", "--version",
   "output version information then quit") do |path|
    puts "airstream v" + Airplay::VERSION
    exit 0
  end
end

if ARGV.empty?
  STDERR.puts "No arguments given"
  STDERR.puts option_parser
  exit 1
end

begin
  option_parser.parse!

  unless options[:reciever]
    STDERR.puts "No host given"
    exit 68
  end

  server = Airstream::Server.new(options[:reciever])

  ARGV.each do |file|
    server.allow_local_httpd = options[:use_local_httpd]
    if server.local_httpd_allowed?
      server.http_path = options[:http_path]
      server.http_url  = options[:http_url]
    end

    server.video = file

    "|/-\\".chars.cycle.each do |c|
      print c; sleep(0.2); print "\b"
      break unless server.loading?
    end

    pbar_options = {
      title: File.basename(file, '.mp4'),
      total: server.video_duration,
      format: '%t %a |%b>>%i| %p%%'
    }
    pbar = ProgressBar.create(pbar_options)
    while server.video_position < server.video_duration
      pbar.progress = server.video_position
      sleep 1.0
    end
    pbar.finish
  end
rescue Interrupt
  STDERR.puts
  STDERR.puts "exiting"
  exit 0
rescue OptionParser::InvalidArgument => ex
  STDERR.puts ex.message
  STDERR.puts option_parser
end

